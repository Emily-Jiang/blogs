---
layout: post
title: "Securing Open Liberty with Red Hat single sign on (RH-SSO)"
# Do NOT change the categories section
categories: blog
author_picture: https://avatars3.githubusercontent.com/rumanaHaque
author_github: https://github.com/rumanaHaque
seo-title: Securing Open Liberty with Red Hat single sign on (RH-SSO) - OpenLiberty.io
seo-description: Learn how you can protect and secure your cloud native Java apps, deployed using Operators, with Open Liberty and RH-SSO, an OpenID Connect (OIDC) provider, allowing users to authenticate themselves once and gain access to applications without needing to re-enter their credentials every time.
blog_description: "Learn how you can protect and secure your cloud native Java apps, deployed using Operators, with Open Liberty and RH-SSO, an OpenID Connect (OIDC) provider, allowing users to authenticate themselves once and gain access to applications without needing to re-enter their credentials every time."
open-graph-image: https://openliberty.io/img/twitter_card.jpg
open-graph-image-alt: Open Liberty Logo
additional_authors:
- name: Grace Jansen
  github: https://github.com/GraceJansen
  image: https://avatars0.githubusercontent.com/GraceJansen
---
= Securing Open Liberty with Red Hat single sign on (RH-SSO)
Rumana Haque <https://github.com/rumanaHaque>
:imagesdir: /
:url-prefix:
:url-about: /
//Blank line here is necessary before starting the body of the post.


link:https://www.ibm.com/topics/single-sign-on[Single Sign-On (SSO)] is a common mechanism that can be used to ensure your cloud applications are protected in today's security-conscious world. This mechanism allows users to authenticate themselves once and gain access to multiple applications or systems without the need to re-enter their credentials every time. This improves productivity and reduces the number of attack surfaces by reducing the number of times users have to sign in and only requiring the use of one set of credentials. To configure single sign-on you can use providers such as GitHub, Google, Facebook or link:https://openliberty.io/docs/latest/reference/feature/openidConnectServer-1.0.html[OpenID Connect (OIDC)]. The main benefits of using OpenID Connect, as opposed to other providers, is that it provides a completely standardized setup and adds an extra layer of protection via link:https://jwt.io/introduction[JSON Web Tokens (JWTs)]. If you're not familiar with JSON Web Tokens, check out the link:https://openliberty.io/guides/microprofile-jwt.html[Open Liberty guide] that explains what they are and how they can be used.

image::/img/blog/RHSSOImage.png[,width=90%,align="center"]

This blog will show you step by step how to configure a Liberty application deployed in OpenShift to use a specific type of OIDC - Red Hat Single SignOn (RH-SSO). RH-SSO was used in this example as it is an integrated sign-on solution available within Open Shift and so is an easily available provider in this environment. We will deploy the Liberty application using the Open Liberty Operator (OLO), to help simplify the deployment process in OpenShift, with special configuration to be able to connect to RH-SSO. After we have deployed the Liberty application, we will configure the RH-SSO to create a client specifically for our liberty application. Once this configuration is complete, we'll verify this has been set up correctly by checking that when we login to our application, we are first re-directed to RH-SSO, and once we authenticate successfully, we'll be redirected back to our application.


== Overview of steps

To show how to configure your Liberty application to use RH-SSO, we'll take a simple Java application running on Liberty, deploy it to OpenShift and configure it to use RH-SSO. Below is an overview of the steps we'll be taking to do this that you can follow:

1) <<prepareApp, Set up, build and containerize the sample application>>

2) <<installRHSSO, Configure the Red Hat OpenShift cluster to make use of RH-SSO>>

3) <<createSecret, Create the olapp-sso secret>>

4) <<deployApp, Install the Open Liberty Operator, and deploy the application to Open Shift using the Open Liberty Operator>>

5) <<createOIDCClient, Create a new client in RH-SSO for the deployed application, so you can use RH-SSO to login to the application>>

6) <<runApp, Run the application, and log in using OIDC>>




[#prepareApp]
== Set up the example application project from our Social Media Guide

Before we get into the details of configuring Security, we first need to set up an example application to apply this security to. For this example, we will have a look at the application used in the Open Liberty guide -  link:/guides/social-media-login.html[Authenticating users through social media providers]

//https://openliberty.io/guides/social-media-login.html


Start by cloning the link:https://github.com/OpenLiberty/guide-social-media-login.git[Git repository] for this guide:
[source]
----

git clone https://github.com/OpenLiberty/guide-social-media-login.git
cd guide-social-media-login
----

The guide "Authenticating users through social media providers" mentioned above uses GitHub for application authentication through the Open Liberty Social Media Login feature. However, in this blog, instead of directly using social platforms to  authenticate with our application, we will use OIDC through RH-SSO. Our first task will be to run the application on our machine, before we attempt to put it in a container. However, before we run the application, we will need to make some changes to the server.xml. First, navigate to the link:https://github.com/OpenLiberty/guide-social-media-login/start/[start/] directory. Update the `server.xml` to the following:



[source]
----
<server description="Social Login Guide Server">
    <featureManager>
        <feature>pages-3.1</feature>
        <feature>appSecurity-5.0</feature>
        <feature>transportSecurity-1.0</feature>
        <feature>mpConfig-3.0</feature>
        <feature>restfulWSClient-3.1</feature>
        <feature>cdi-4.0</feature>
        <feature>jsonb-3.0</feature>
        <feature>jwt-1.0</feature>
        <feature>socialLogin-1.0</feature>
    </featureManager>

    <httpEndpoint httpPort="9080"
                  httpsPort="9443"
                  id="defaultHttpEndpoint"
                  host="*" />

            <!-- when running with Open Liberty Operator, server.xml no longer needs to specify keystore/truststore, using the ENV var SEC_TLS_TRUSTDEFAULTCERTS and overrides/truststore.xml
    <keyStore id="defaultKeyStore"
              password="changeit" />

    <ssl id="defaultSSLConfig"
         keyStoreRef="defaultKeyStore"
                    trustDefaultCerts="true" />
            -->

    <webApplication location="guide-social-login.war">
        <application-bnd>
            <security-role name="users">
                <special-subject type="ALL_AUTHENTICATED_USERS"/>
            </security-role>
        </application-bnd>
    </webApplication>
</server>

----


This edited `server.xml` provides the feature `socialLogin-1.0` to your application's feature list, and adds the required ports. The configuration previously provided for the keystore and truststore is now commented out as this is no longer needed when running the application with the Open Liberty Operator, as we will do in this example.


== Build and run the updated Application
After updating the server.xml file, you're now ready to build and then run the application. Before you can deploy this application to OCP, you first need to build the `WAR` for the application. Later on, you can use this `WAR` file in a container image and use that to deploy this application in OCP. To build the application, run the following command:
[source]
----
mvn package
----

This command builds a `target/guide-social-login.war` archive.

In order to test that your application is working correctly, run the application in your local machine first. Use the following commands:

[source]
----
cd start
mvn liberty:run
----

This will install the application you built above in a Liberty server, and then start the Liberty server and the application. If everything completes successfully, you should see a line that says 
[source]
----
 Application guide-social-login started ..
----

Access the app using the url http://localhost:9080/guide-social-login/hello.html

You should see a page that says "Welcome to the social media login guide", with a button to Log in.


//[.img_border_light]
//image::img/blog/rh_social_media_guide.png[Social Media Login,width=70%,align="center"]

[.img_border_light]
image::img/blog/rh_social_media_guide.png[Social Media Login Guide,width=50%,align="center"]


After you finish checking out the application, stop the Open Liberty server by pressing CTRL+C in the command-line session where you ran the server. We can now include the `WAR` file you built above in a container image so it can be used to deploy this application in OCP.


== Containerizing the application

To deploy the application on Open Shift using the Open Liberty Operator, you must first containerize this using the Open Liberty image. For this example, we will use an official image from the IBM Container Registry (ICR), `icr.io/appcafe/open-liberty:full-java17-openj9-ubi`, as the parent image. You can use the Dockerfile shown below to build the application image.

[#dockerfile]
=== Create the Dockerfile for the application

.Dockerfile
[source]
----
#Use latest Open Liberty build
FROM icr.io/appcafe/open-liberty:full-java17-openj9-ubi


# Optional functionality
ARG TLS=true
ARG SEC_SSO_PROVIDERS="oidc"
#ARG OPENJ9_SCC=false
ARG VERBOSE=true

# trust certificates from well known CA's
ENV SEC_TLS_TRUSTDEFAULTCERTS=true

# trust certificates from within the cluster, such as Red Hat SSO.
ENV SEC_IMPORT_K8S_CERTS=true


COPY --chown=1001:0  src/main/liberty/config/server.xml /config/
COPY --chown=1001:0  target/guide-social-login.war /config/apps


# This script will add the requested XML snippets and grow image to be fit-for-purpose
RUN configure.sh

----
Ensure that you have the ENV values, `ENV SEC_TLS_TRUSTDEFAULTCERTS` and `ENV SEC_IMPORT_K8S_CERTS` set to true, so you can trust all the certificates from within the cluster. By specifying `ARG SEC_SSO_PROVIDERS="oidc"`, you are telling the configuration that the SSO provider you will be using is OIDC. You can find out more about all the configuration options available in the link:https://github.com/OpenLiberty/ci.docker/blob/main/SECURITY.md#single-sign-on-configuration[single sign-on configuration documentation].

To containerize the image, in the start/ directory of the application you checked out from Git, create a Dockerfile with the content above. Build the application image using this Dockerfile, and upload to a repository of your choice (e.g. dockerhub or artifactory). You'll need to make a note of the image location so that you can use it later on for deploying this application to OpenShift using the Open Liberty Operator (OLO).

With this step, we have completed the steps needed to successfully set up the application. Now we can move onto the next setp of installing and configuring their openshift cluster for us to deploy this application to.


[#installRHSSO]
== Installing and configuring RH-SSO (RedHat Single Sign-On) Operator in the OpenShift cluster

We will now walk through the steps necessary to correctly set up our OpenShift cluster so that we can make use of RH-SSO. 

. Install RH-SSO

We need to install the Red Hat Single Sign-On Operator to the cluster. When installing this operator, ensure that it is installed in the namespace - "rh-sso". To do this, follow the instructions provided in the link:https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.6/html/server_installation_and_configuration_guide/operator#doc-wrapper[Red Hat documentation].

. Create a KeyCloak instance, and log in to the instance

After installing the RH-SSO Operator, create a KeyCloak instance using the default values provided. After creating the KeyCloak instance, you should be able to access the KeyCloak by looking at the routes. The route should be in this format - https://keycloak-rh-sso.apps.<cluster_name>. You will ise this URL to log in to this KeyCloak instance. The credentials for logging in are in the secret - credential-example-keycloak (in the rh-sso nampspace). Get the secret password from the console for the admin username in this secret, then use this username and password to login on to the KeyCloak.

. Create a realm named "sso-realm"

After logging in, create a realm, called - "sso-realm".
This is the url to access this realm:
https://keycloak-rh-sso.apps.<cluster-name>/auth/admin/master/console/#/realms/sso-realm

. Create users for this realm

Next we need to create users (non-admin) for this realm. We can use them to test social login when RH-SSO is used as an OIDC provider, the non-admin users can be used to log in to the client application. First, create a user called "testuser1". To do this, after logging in, select `Manage -> Users` and select `Add user`. Then put in the value "testuser1" for `Username`, and click on `Save`.

[.img_border_light]
image::img/blog/rh_create_testuser1.png[Create testuser1,width=50%,align="center"]

After saving, on the next page, select `Credentials` tab. Enter the password (testpasswd1) on the next page and ensure to change `ON` to `Off` for `Temporary`. Click on `Reset Password`, and on the confirmation dialog, select `Change Password`. Then, go to the `Role Mappings` tab. On the Role Mappings page, under `Client Roles` drop-down, select `realm-management`. After the `realm-management` role is selected, additional boxes such as `Available Roles` will appear. Under `Available Roles`, search for `view-realm` and select `Add selected`. After the role is selected, it appears under `Assigned Roles` and `Effective Roles`.

__Note: Selecting the role is just a basic requirement to allow the user to login to the user's console on RH-SSO. If without any role assigned, the user will get Forbidden error msg on the browser after login.__

[.img_border_light]
image::img/blog/rh_testuser1_roles.png[Roles for testuser1,width=50%,align="center"]

Use the url, https://keycloak-rh-sso.apps.<cluster-name>/auth/admin/Sso-realm/console/, to test the users you just created (testuser1). You should be able to log in successfully using the testuser1/testpasswd1. After logging in, in the `General Section`, you should see the endpoints. Click on the link for the OpenID Endpoint Configuration - and that should point you to -
https://keycloak-rh-sso.apps.<cluster-name>/auth/realms/sso-realm/.well-known/openid-configuration. This will be needed for the client registration as the `discoveryEndpoint` later on.

[#createSecret]
== Create the olapp-sso secret 

Next, we will need to create a secret for the Open Liberty Application. To do this, create a new project in your cluster called `gsm-test`, and create a secret in that namespace (`Workloads->Secrets->Create Secret`), called `guide-social-media-login-olapp-sso`, using the key `oidc-clientId` and value `gsmapp`.

[.img_border_light]
image::img/blog/rh_create_secret.png[Create olapp-sso secret,width=50%,align="center"]

The key name should be in this format <app-name>-olapp-sso. You must use the same <app-name> as the one you will use while deploying the applicaton using OLO. For example, in the application used here in the blog, the <app-name> from the yaml file is `guide-social-media-login`, so the secret name is `guide-social-media-login-olapp-sso`.


[#deployApp]
== Installing the Open Liberty Operator, and deploying the application to OpenShift using the Open Liberty Operator

If you don't already have the Open Liberty Operator (OLO) in your OCP cluster, visit this link:https://openliberty.io/docs/latest/open-liberty-operator.html[documentation] to see how to add this to your cluster.

After installing the Open Liberty Operator, use the yaml file given below to deploy the Open Liberty App (guide-social-media-login) - for which you created the image using the Dockerfile mentioned earlier.

[source]
----
apiVersion: apps.openliberty.io/v1
kind: OpenLibertyApplication
metadata:
  name: guide-social-media-login
  namespace: gsm-test
spec:
  sso:
    oidc:
      - discoveryEndpoint: >-
          https://keycloak-rh-sso.apps.<cluster-name>/auth/realms/sso-realm/.well-known/openid-configuration
  service:
    port: 9443
  applicationImage: >-
    <image location of the app>
  expose: true
  manageTLS: true
  replicas: 1
  applicationName: guide-sm-login
  pullPolicy: Always
  pullSecret: <secret_to_pull_image>


----

Note that the name of the application deployed is `guide-social-media-login`, the same name that was used when creating the secret above. The value `Application image` needs to point to your image location (i.e. where you placed your Application image, in a Container Registrty like DockerHub or Artifactory). The value `pullSecret` also needs to set to be able to access the access the Container Registry. Additionally, the `oidc: discoveryEndpoint` needs to point to the OpenID Endpoint Configuration that you set while configuring the RH-SSO Operator.

[#createOIDCClient]
== Create the OIDC Client in RH-SSO

In order for your application to make use of Single Sign On using RH-SSO, you will need to register your application as a client in RH-SSO. Since we have already deployed the `guide-social-media-login` app using the Open Liberty Operator, we can now complete the registration for the OpenID client.

Follw these steps to create your application as a RH-SSO client:

. Access the Console for the RH-SSO, using this url - https://keycloak-rh-sso.apps.<cluster-name>/auth/admin/master/console/, and log in to the Console using the credentials from the secret - `credential-example-keycloak` defined in your OCP cluster.
. Create a new Client - Click on `Create`, and specify the clientId as `gsmapp`. (the same value that you put in the secret created called `guide-social-media-login-olapp-sso`), and click `Save`. 
. On the settings page, ensure the default setting `Enabled` is set to 'ON' to ensure the client is enabled for login, and `Access Type` is set to `public` which doesn't require a secret for login. 
. Specify the URL for Valid Redirect URIs. In the scenario with 'oidcLogin', the URL will be in the format https://<app-name>-<namespace>.apps.<cluster-name>/ibm/api/social-login/redirect/oidc. Since you have already deployed the application named guide-social-media-login, use this value for the Valid Redirect URI, substituting <cluster-name> with the name of your cluster - 
https://guide-social-media-login-gsm-test.apps.<cluster-name>/ibm/api/social-login/redirect/oidc and click on Save.

[#runApp]
== Running the application, and logging in using OIDC

Congratulations! You've now completed all the required configurations to use SSO to login to your application. Now, you're ready to run the application. When you click on the "Log In" button for the app, it will now redirect you to the RH-SSO console, where you can log in using the username and password that you created earlier.

First, access the application URL by getting the route of the application from the `gsm-test` project. It should be in this format: https://guide-social-media-login-gsm-test.apps.<cluster-name>/guide-social-login/hello.html

You should see the application as shown below.

[.img_border_light]
image::img/blog/rh_social_media_login.png[Social Media Login,width=50%,align="center"]

Since you have already registered the RH-SSO client for this application, when you click on the "Log In" button for this app, it will redirect you to the RH-SSO client.

[.img_border_light]
image::img/blog/rh_social_media_redirect.png[Social Media Login Redirect,width=50%,align="center"]

Log in using testuser1/testpasswd1, and it will redirect you back to the application, where you are now authenticated.

[.img_border_light]
image::img/blog/rh_social_media_logged_in.png[Social Media Logged in after Redirect,width=50%,align="center"]

By following the steps mentioned above, you have successfully secured your Liberty Application running in Open Shift, so you can authenticate and authorize your users using OAuth.

== Summary and Next Steps

We started the blog with an application (which used OAuth) running on-prem. Then we went through the steps that first containerized the application, so that it could be deployed in Open Shift Cluster (OCP). Then we deployed the application to OCP. Then we secured the application by configuring it to use Red Hat Single Sign On (RH-SSO), so when you want to login to the app, it will now redirect you to the RH-SSO, where you have to login and authenticate yourself in order to get access to the application. Finally you have a secure application that is deployed and ready to run in an OpenShift cluster. 

If you would like to continue your education of securing your cloud native Java applications, then check out the interactive, hands-on guides we have on the Open Liberty website: https://openliberty.io/guides/#security.

